var empresasParaVincular=[],cnpjPrincipal="",isErrorVinculo=!1;function verifyLoginForSBRT(o){var e=$("#conteudoExigeLogin").val(),a=$("#conteudoExclusivoPJ").val();$("#modal-cad-pj-close").hide(),$("#modal-cad-pj-cancelar").hide(),getKeycloak((function(t){if($("#buttonLogar-modalConteudoExclusivo").off("click"),$("#buttonCadastrar-modalConteudoExclusivo").off("click"),$("#buttonFechar-modalConteudoExclusivo").off("click"),$("#buttonLogar-modalConteudoExclusivo").on("click",(function(o){o.preventDefault(),window.location.href=t.createLoginUrl()})),$("#buttonLogar-modalConteudoExclusivo").attr("data-sb-rotulo","Faça o login - "+t.createLoginUrl()),$("#buttonCadastrar-modalConteudoExclusivo").on("click",(function(o){o.preventDefault(),window.location.href=t.createLoginUrl({action:"register"})})),$("#buttonCadastrar-modalConteudoExclusivo").attr("data-sb-rotulo","Cadastre-se - "+t.createRegisterUrl()),$("#buttonFechar-modalConteudoExclusivo").on("click",(function(o){o.preventDefault(),$("#modalConteudoExclusivo").fadeOut("fast").removeClass("active"),$("html, body").css("overflow","")})),"1"===e||"1"===a)if(t.authenticated)if("1"===a){var n=t.tokenParsed;void 0!==n.empresas?n.empresas.length<1?exibeCadastroPJ():o():exibeCadastroPJ()}else o();else showModalExigeLogin();else o()}))}function verifyLoginForCtdArquivo(o){var e=$("#conteudoExigeLogin").val(),a=$("#conteudoExclusivoPJ").val();$("#modal-cad-pj-close").hide(),$("#modal-cad-pj-cancelar").hide(),getKeycloak((function(t){if($("#buttonLogar-modalConteudoExclusivo").off("click"),$("#buttonCadastrar-modalConteudoExclusivo").off("click"),$("#buttonFechar-modalConteudoExclusivo").off("click"),$("#buttonLogar-modalConteudoExclusivo").on("click",(function(o){o.preventDefault();const e=new URL(window.location.href);e.searchParams.set("openFile",!0),window.location.href=t.createLoginUrl({redirectUri:e.href})})),$("#buttonLogar-modalConteudoExclusivo").attr("data-sb-rotulo","Faça o login - "+t.createLoginUrl()),$("#buttonCadastrar-modalConteudoExclusivo").on("click",(function(o){o.preventDefault();const e=new URL(window.location.href);e.searchParams.set("openFile",!0),window.location.href=t.createLoginUrl({action:"register",redirectUri:e.href})})),$("#buttonCadastrar-modalConteudoExclusivo").attr("data-sb-rotulo","Cadastre-se - "+t.createRegisterUrl()),$("#buttonFechar-modalConteudoExclusivo").on("click",(function(o){o.preventDefault(),$("#modalConteudoExclusivo").fadeOut("fast").removeClass("active"),$("html, body").css("overflow","")})),"1"===e||"1"===a)if(t.authenticated)if("1"===a){var n=t.tokenParsed;void 0!==n.empresas?n.empresas.length<1?exibeCadastroPJ():$("#conteudoArquivoVcmid").val()?showBlockedContent():o():exibeCadastroPJ()}else $("#conteudoArquivoVcmid").val()?showBlockedContent():o();else $("#conteudoArquivoVcmid").val()?window.location.href=t.createLoginUrl():showModalExigeLogin();else $("#conteudoArquivoVcmid").val()?showBlockedContent():o()}))}function verifyLogin(){var o=$("#conteudoExigeLogin").val(),e=$("#conteudoExclusivoPJ").val();$("#modal-cad-pj-close").hide(),$("#modal-cad-pj-cancelar").hide(),getKeycloak((function(a){$("#buttonLogar-modalConteudoExclusivo").on("click",(function(o){o.preventDefault(),window.location.href=a.createLoginUrl()})),$("#buttonLogar-modalConteudoExclusivo").attr("data-sb-rotulo","Faça o login - "+a.createLoginUrl()),$("#buttonCadastrar-modalConteudoExclusivo").on("click",(function(o){o.preventDefault(),window.location.href=a.createLoginUrl({action:"register"})})),$("#buttonCadastrar-modalConteudoExclusivo").attr("data-sb-rotulo","Cadastre-se - "+a.createRegisterUrl()),$("#buttonFechar-modalConteudoExclusivo").on("click",(function(o){o.preventDefault();var e=window.location.protocol+"//"+window.document.domain+"/sites/PortalSebrae";history.length>2?history.go(-1):window.location.href=e}));var t=a.authenticated;if(console.log(t?"verifyLogin authenticated":"verifyLogin not authenticated"),"1"===o||"1"===e)if(t)if("1"===e){var n=a.tokenParsed;void 0!==n.empresas?n.empresas.length<1?exibeCadastroPJ():showBlockedContent():exibeCadastroPJ()}else showBlockedContent();else{var r=$("#conteudoArquivoVcmid").val();null!=r&&""!==r?window.location.href=a.createLoginUrl():showModalExigeLogin()}else showBlockedContent()}))}function showModalExigeLogin(){console.log("Chamou showModalExigeLogin"),"PS-CTD-AUDIO"===$("#tipoConteudo").val()||"PS-CTD-VIDEO"===$("#tipoConteudo").val()||"PS-CTD-ARQUIVO"===$("#tipoConteudo").val()?(console.log("Tipo é igual a Audio, Video ou Arquivo"),$("#modalConteudoExclusivo").fadeIn("fast").addClass("active"),document.getElementsByClassName("sb-structure__footer__a-z-button")[0].style.display="none",$("#icons-first-interaction").hide(),$("html, body").css("overflow","hidden")):(console.log("Tipo diferente Audio, Video ou Arquivo"),setTimeout((function(){$("#modalConteudoExclusivo").fadeIn("fast").addClass("active"),document.getElementsByClassName("sb-structure__footer__a-z-button")[0].style.display="none",$("#icons-first-interaction").hide(),$("html, body").css("overflow","hidden")}),2e3))}function exibeCadastroPJ(){$("#modal-cad-pj").fadeIn("fast").addClass("active"),atualizarListaEmpresas()}function showBlockedContent(){var o=$("#conteudoArquivoVcmid").val();console.log("carregando conteudo bloqueado "+o),null!=o&&""!==o&&$.ajax({url:"/sebraena-templating/controller/util/placementPath/"+o,crossDomain:!0,success:function(o){var e=JSON.parse(o);e.placementPath&&(console.log("json.placementPath : "+e.placementPath),e.placementPath.endsWith(".pdf")?(console.log("json.placementPath é um pdf"),setTimeout((()=>{console.log("Aguarda para abrir"),window.open(e.placementPath,"_self")}),5e3)):(console.log("json.placementPath NÃO é um pdf"),window.open(e.placementPath,"_self")))},error:function(o,e,a){console.log("placementPath ajax error")}})}function adicionarCNPJ(o){o?($("#modal-cad-pj-content").show(),$("#modal-cad-pj-error").hide(),$("#showMessageError").show(),$("#showMessageError").prop("hidden",!1),$(".select-selected").addClass("set-error-color"),isErrorVinculo=o):($("#showMessageError").hide(),$("#showMessageError").prop("hidden",!0),$(".select-selected").removeClass("set-error-color"),isErrorVinculo=!1),getKeycloak((function(o){$.getJSON("/Sebrae/Portal Sebrae/resources/js/amei/endpoints.json").then((function(e){let a=document.getElementById("cadastroEmpresa").value.replace(/[^0-9]/g,"");for(var t=0;t<empresasParaVincular.length;t++)if(empresasParaVincular[t]===a)return void alert("Cnpj já inserido");if(""===a||null===a)document.getElementById("cnpjInput").classList.add("error"),document.getElementById("pjError").style.display="block";else if(14!==a.length)alert("CNPJ inválido. Deve conter 14 digitos(utilize apenas números)");else{document.getElementById("cnpjInput").classList.remove("error"),document.getElementById("pjError").style.display="none";try{$.ajax({url:e.origin+"/v1/cpe/pj/"+a+"?allcontent=true",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"bearer "+o.token},crossDomain:!0,jsonpCallback:"jsonRetorno",timeout:6e4,async:!1,type:"GET",cache:!1,data:{},success:function(a,t,n){if(200===n.status){const t=getVinculosEmpresaTipoAsHTML(e,o);var r={nomeFantasia:a.nomeFantasia,cnpj:a.cnpj,parceira:!1,situacaoCadastral:["02","04","99"].find((o=>o==a.situacaoCadastral))?"Ativo":"Baixada",tiposVinculo:t};atualizarListaEmpresas(r),3!==parseInt(a.porte)&&2!==parseInt(a.porte)&&99!==parseInt(a.porte)&&($("#cadastrarEmpresa").addClass("disabled"),$("#adicionarEmpresa").addClass("disabled"),$("#cadastroEmpresa").prop("disabled",!0),document.getElementById("cadastroEmpresa").disabled=!0,$("#modal-pj-info").prop("hidden",!1),document.getElementById("companyName").innerHTML=r.nomeFantasia,document.getElementById("companyPort").innerHTML=porte[r.porte]),document.getElementById("cadastroEmpresa").value=""}else alert("CNPJ não existente na base de dados")},error:function(o){alert("Ocorreu um erro ao buscar esse CNPJ na base de dados")}})}catch(o){}}}))}))}var Form={cnpjField:()=>$("#cadastroEmpresa"),cnpjAddBtn:()=>$("#adicionarEmpresa"),empresaAddBtn:()=>$("#cadastrarEmpresa")};function definirComoPrincipal(o){cnpjPrincipal!==o?(cnpjPrincipal=o,$(`[data-form-id="${o}"] .modal-cad-pj__favorite-button`).text("Prioritário"),$(`[data-form-id="${o}"] .modal-cad-pj__favorite-button`).addClass("active"),empresasParaVincular.find((e=>e.cnpj===o)).isPrioritario=!0):(cnpjPrincipal="",$(`[data-form-id="${o}"] .modal-cad-pj__favorite-button`).text("Definir como prioritário"),$(`[data-form-id="${o}"] .modal-cad-pj__favorite-button`).removeClass("active"),empresasParaVincular.find((e=>e.cnpj===o)).isPrioritario=!1)}function empresaParceira(o){o&&(empresasParaVincular[empresasParaVincular.length-1].parceira=!0),$("#cadastrarEmpresa").removeClass("disabled"),$("#modal-pj-info").prop("hidden",!0)}function cadastrarEmpresas(){$.getJSON("/Sebrae/Portal Sebrae/resources/js/amei/endpoints.json").then((function(o){for(var e=0,a=0;a<empresasParaVincular.length;a++){var t=empresasParaVincular[a],n=$($("#select-vinculo .select-items .active").get(0)).attr("data-value");getKeycloak((function(a){$.ajax({url:o.origin+"/v1/cpe/pj/vincular/"+t.cnpj+"/"+t.parceira.toString()+`?idTipoVinculo=${n}`,headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"bearer "+a.token},crossDomain:!0,jsonpCallback:"jsonRetorno",timeout:6e4,async:!1,type:"POST",cache:!1,data:{},success:function(o){e++,empresasParaVincular.length==e&&userInfoToCommonObjectAdapter((function(o){"function"==typeof getUserInfoSubscription&&"function"==typeof showUserData?($(empresasParaVincular).each((function(){o.empresas.push({cnpj:this.cnpj,nomeFantasia:this.nomeFantasia,codigo:this.cnpj})})),getUserInfoSubscription(o),showUserData()):"function"==typeof showBlockedContent&&showBlockedContent(),cancelarCadastro(),$("#btnInscreva-se").attr("href","javascript:submitSubscription()")}))},error:function(o,e,a){JSON.parse(o.responseText);$("#modal-cad-pj-content").hide(),$("#modal-cad-pj-error").show(),$("#modal-cad-pj-error").prop("hidden",!1)}})}))}}))}function cancelarCadastro(){empresasParaVincular=[],$("#cadastrarEmpresa").removeClass("disabled"),$("#adicionarEmpresa").removeClass("disabled"),$("#modal-pj-info").prop("hidden",!0),$("#modal-cad-pj").fadeOut("fast").removeClass("active"),$("#fecharModal").click(),document.getElementById("cadastroEmpresa").value=""}function removerCNPJ(o){empresasParaVincular=empresasParaVincular.filter((e=>e.cnpj!=o)),atualizarListaEmpresas()}function atualizarListaEmpresas(o){if(null!=o&&empresasParaVincular.push(o),empresasParaVincular.length>0){$("#cadastrarEmpresa").removeClass("disabled");const o=buildEmpresasTable({nome:empresasParaVincular[0].nomeFantasia,cnpj:empresasParaVincular[0].cnpj,tiposVinculo:empresasParaVincular[0].tiposVinculo,situacaoCadastral:empresasParaVincular[0].situacaoCadastral});document.getElementById("empresasVincular").innerHTML=o,getDrop();const e=$('#select-vinculo .select-items div[data-value="32392"]');e.length&&e.click()}else $("#cadastrarEmpresa").addClass("disabled"),$("#adicionarEmpresa").removeClass("disabled"),$("#cadastroEmpresa").prop("disabled",!1),$("#modal-pj-info").prop("hidden",!0),cnpjPrincipal="",document.getElementById("empresasVincular").innerHTML=""}function getVinculosEmpresaTipoAsHTML(o,e){let a="";return $.ajax({url:o.origin+"/v1/cpe/vinculo-empresa/tipo",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"bearer "+e.token},crossDomain:!0,jsonpCallback:"jsonRetorno",timeout:6e4,async:!1,type:"GET",cache:!0,data:{},success:function(o,e,t){if(200===t.status&&o&&o.length){a=`\n                <div class="custom-select">\n                  <div id="select-selected-vinculo" class="select-selected">Selecione</div>\n                  <div class="select-items">\n                    ${function buildRows(o){return o.map((o=>`<div id="select-${o.id}" data-value="${o.id}" onclick="doThisSelectOnChange(this.id)">${formatDesTipoVinculo(o.descricao)}</div>`)).join("")}(o)}\n                  </div>\n                  <div class="select-arrow"></div>\n\t\t\t\t\t<div class="sb-components__form__ipt-group error" id="showMessageError" hidden>\n\t\t\t\t\t\t<span class="set-error-vinculo">Vínculo selecionado não corresponde ao CNPJ informado.</span>\n\t\t\t\t\t</div>\n                </div>\n                `}},error:function(o){alert("Ocorreu um erro na busca de tipos de empresa")}}),a}function doThisSelectOnChange(o){"proprietário ou sócio"!==document.getElementById(o).innerText.toLowerCase()?($(".select-selected").removeClass("set-error-color"),$("#showMessageError").hide(),$("#showMessageError").prop("hidden",!0)):!0===isErrorVinculo&&($(".select-selected").addClass("set-error-color"),$("#showMessageError").show(),$("#showMessageError").prop("hidden",!1))}function formatDesTipoVinculo(o){return o.split(" ").map((o=>"O"===o[0].toUpperCase()?o[0].toLowerCase()+o.substring(1).toLowerCase():o[0].toUpperCase()+o.substring(1).toLowerCase())).join(" ")}function buildEmpresasTable({nome:o,cnpj:e,tiposVinculo:a,situacaoCadastral:t}){return`\n    <div class="sb-components-accordion">\n      <ul>\n        <li class="active" data-form-id=${e}>\n          <button\n            type="button"\n            class="sb-components-accordion-open sb-not-scroll"\n            data-sb-acao="clique"\n            data-sb-rotulo="empresa"\n          >\n           ${o}\n          </button>\n          <div class="sb-components-accordion-content" style="display: block">\n            <div class="sb-components__table" id="empresasVincular">\n              <table>\n                <tbody>\n                  <tr>\n                    <td><strong>CNPJ:</strong></td>\n                    <td align="right">${e.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,"$1.$2.$3/$4-$5")}</td>\n                  </tr>\n                  <tr id="select-vinculo">\n                    <td><strong>Tipo de vínculo:</strong></td>\n                    <td align="right">${a}</td>\n                  </tr>\n                  <tr>\n                    <td><strong>Situação:</strong></td>\n                    <td align="right">${t}</td>\n                  </tr>\n                </tbody>\n              </table>\n            </div>\n            <span class="modal-cad-pj__trash-button btn-top" onclick="removerCNPJ('${e}')"></span\n            ><button\n              type="button"\n              data-sb-acao="clique"\n              data-sb-rotulo="principal"\n              class="modal-cad-pj__favorite-button"\n              onclick="definirComoPrincipal('${e}')"\n            >\n              Definir como prioritário\n            </button>\n          </div>\n        </li>\n      </ul>\n    </div>\n    `}$(document).ready((function(){"1"===$("#isSbrtPage").val()?($(".sbrt-download").on("click",(()=>verifyLoginForSBRT(handleSbrtDownloadClick))),$(".sbrt-email").on("click",(()=>verifyLoginForSBRT(handleSbrtEmailClick)))):"1"===$("#isCtdArquivoPage").val()?(window.location.search.includes("openFile=true")&&verifyLoginForCtdArquivo(clickDownload),$("#downloadButton").length?$("#downloadButton").on("click",(()=>verifyLoginForCtdArquivo(clickDownload))):verifyLoginForCtdArquivo((()=>{}))):verifyLogin()}));
