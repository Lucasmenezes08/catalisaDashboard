window.cpeCache=window.cpeCache||{};var modalIsShowing=!1,getKeycloak=function(){function checkCpeEmpresas(e,o){cpeCache.currentToken&&cpeCache.currentToken===e.token&&!cpeCache.lock?o(e):cpeCache.lock?(cpeCache.listeners||(cpeCache.listeners=[]),cpeCache.listeners.push({callback:o})):(cpeCache.lock=!0,$.getJSON((window.urlAmbiente?window.urlAmbiente:"")+"/Sebrae/Portal Sebrae/resources/js/amei/endpoints.json",(t=>{$.ajax({url:`${t.origin}/v1/cpe/pj/vincular`,headers:{Authorization:`Bearer ${e.token}`},crossDomain:!0,success:function(t){t&&e.tokenParsed&&(e.tokenParsed.empresas=t,cpeCache.data=t,cpeCache.currentToken=e.token);try{for(var a of(tryToExecute(o,e),cpeCache.lock=!1,cpeCache.listeners))tryToExecute(a.callback,e);cpeCache.listeners=[]}catch(e){console.log(e)}},error:function(t,a,n){o(e),cpeCache.lock=!1,console.log("placementPath ajax error"),cpeCache.listeners.forEach((o=>o.callback(e))),cpeCache.listeners=[]}})})))}function tryToExecute(e,o){try{e&&e(o)}catch(e){console.log(e)}}function validadeAMEIAttributes(e){if(!e.authenticated)return!1;const{uf:o,cpf:t,firstName:a,family_name:n,genero:c,dataNascimento:r,cep:s,cidade:i,bairro:l,logradouro:d,email:u,telefoneCelular:h}=e.tokenParsed,k={uf:o,cpf:t,firstName:a,family_name:n,genero:c,dataNascimento:r,cep:s,cidade:i,bairro:l,logradouro:d,email:u},p=[];o||p.push("UF"),t||p.push("CPF"),a||p.push("nome"),n||p.push("sobrenome"),c||p.push("genero"),r||p.push("data de nascimento"),s||p.push("CEP"),i||p.push("cidade"),l||p.push("bairro"),d||p.push("logradouro"),u||p.push("email"),h||p.push("telefone celular"),sessionStorage.tabID||sessionStorage.setItem("tabID",Math.random());const m=new BroadcastChannel("AMEI-state-update");function updateCookie(){const e=hashThat(JSON.stringify(k)),o=new Date((new Date).getTime()+18e5).toUTCString();document.cookie=`AMEILastState=${e};expires=${o}; path=/`}function hashThat(e){let o=0;for(var t=0;t<e.length;t++){o=(o<<5)-o+e.charCodeAt(t),o&=o}return o}if(m.addEventListener("message",(e=>{e.data!=sessionStorage.getItem("tabID")&&window.location.reload()})),-1!==document.cookie.indexOf("AMEILastState")){let e=document.cookie.substring(document.cookie.indexOf("AMEILastState=")+14);e=e.substring(0,e.indexOf(";"));const o=hashThat(JSON.stringify(k));if(console.log(e,o),e!=o)return updateCookie(),void(0===p.length&&m.postMessage(sessionStorage.getItem("tabID")))}const g=`\n      <div id="modal-verificacao" class="sb-modal sb-grid" style="display: block;">\n        <div class="sb-modal__wrapper ">\n          <div class="sb-modal__wrapper__content update-data">\n            <div class="sb-modal__wrapper__content__title">\n              <img\n                src="https://www.sebrae.com.br/Sebrae/Portal%20Sebrae/Fale%20Conosco/sb-consultoria.png"\n                alt="sebrae"\n              />\n              <h1 class="sbAccessibilityFontSize">Olá!</h1>\n              <p class="sbAccessibilityFontSize">\n                Verificamos que os seus dados cadastrais estão desatualizados. Por favor, atualize a(s)\n                informação(ões) de ${p.join(", ")} para aproveitar o melhor do Sebrae.\n              </p>\n              <a href="${e.createAccountUrl({redirectUri:window.location.href})}" class="sb-components__button update-data-button inline radius-4" >Atualizar meus dados</a>\n            </div>\n          </div>\n        </div>\n      </div>`;p.length>0?(updateCookie(),modalIsShowing||($("body").append(g),modalIsShowing=!0)):window.ModalsConfig={block:!1}}var e,o=new XMLHttpRequest;window.urlAmbiente||(window.urlAmbiente=""),o.open("GET",urlAmbiente+"/Sebrae/Portal Sebrae/resources/js/amei/keycloak.json?v="+((e=new Date).getFullYear()+("0"+(e.getMonth()+1)).slice(-2)+("0"+e.getDate()).slice(-2)+("0"+e.getHours()).slice(-2)+("0"+e.getMinutes()).slice(-2)),!1),o.send();try{const e=new Keycloak(JSON.parse(o.responseText));return e.onTokenExpired=()=>{e.updateToken(5).then((o=>{o&&(localStorage.setItem("kcToken",e.token),localStorage.setItem("kcRefreshToken",e.refreshToken),localStorage.setItem("kcTokenTTL",e.tokenParsed.exp))})).catch((e=>{localStorage.removeItem("kcToken"),localStorage.removeItem("kcRefreshToken"),localStorage.removeItem("kcTokenTTL"),console.error("Algo errado ao atualizar o token ou a sessão expirou",e)}))},function(o){if(window.ModalsConfig={block:!0},e.authenticated||cpeCache&&cpeCache.lock)return window.ModalsConfig={block:!1},checkCpeEmpresas(e,o);(function getKcInitPromise(e){const o=localStorage.getItem("kcToken"),t=localStorage.getItem("kcRefreshToken"),a=localStorage.getItem("kcTokenTTL"),n=(new Date).getTime()/1e3;let c;return c=o&&t&&a&&a-n>30?e.init({onLoad:"login-required",token:o,refreshToken:t}):e.init({onLoad:"check-sso",silentCheckSsoRedirectUri:window.location.origin+"/sebraena-templating/views/silent-check-sso.html",promiseType:"native",redirect_uri:window.location.href,checkLoginIframe:!0,flow:"standard",silentCheckSsoFallback:!1}),c})(e).then((function(t){t?e.updateToken(5).then((function(){validadeAMEIAttributes(e),localStorage.setItem("kcToken",e.token),localStorage.setItem("kcRefreshToken",e.refreshToken),localStorage.setItem("kcTokenTTL",e.tokenParsed.exp),checkCpeEmpresas(e,o)})).catch((function(e){console.error("Failed to refresh token",e)})):(validadeAMEIAttributes(e),localStorage.removeItem("kcToken"),localStorage.removeItem("kcRefreshToken"),localStorage.removeItem("kcTokenTTL"),o(e))})).catch((e=>(window.ModalsConfig={block:!1},console.error(e),function(){})))}}catch(e){return function(){}}}();function updateTokenRedirect(e){getKeycloak((function(o){window.location.href=e}))}